name: Deploy with Docker Compose

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  create-docker-image:
    runs-on: ubuntu-latest     
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: login to github container registry
        uses: docker/login-action@v1
        with: 
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.EXAMPLE_TOKEN }}  # se da da alta en las setting del usuario->developer setting-> personal access token-> tokens: Me genera este:  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
                                                    # despues este token hay que darlo de alta en la variable del repositorio: seting->secrets and variables-> actions-> repository secrets      

      - name: build image
        run: |
          docker build . --tag ghcr.io/gallegojl1/imagen-docker-web:latest
          docker push ghcr.io/gallegojl1/imagen-docker-web:latest
          
      - name: ssh into server
        run: |
            sshpass -p ${{ secrets.PASS_SERVER }} ssh -o StrictHostKeyChecking=no ${{ secrets.AUTH_SERVER }} << EOF
              echo "hola mundo"
        
              # Docker login & deploy
              echo ${{ secrets.EXAMPLE_TOKEN }} | docker login ghcr.io -u gallegojl1 --password-stdin
              sudo docker pull ghcr.io/gallegojl1/imagen-docker-web:latest
              sudo docker stop imagen-docker-web || true
              sudo docker rm imagen-docker-web || true
              sudo docker run -d --name imagen-docker-web ghcr.io/gallegojl1/imagen-docker-web:latest
            EOF
            
